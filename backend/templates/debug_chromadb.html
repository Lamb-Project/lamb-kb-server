<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug ChromaDB Collections - Lamb KB Explorer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="d-flex align-items-center justify-content-between mb-4">
            <h1>ChromaDB Debugger</h1>
            <div>
                <a href="{{ url_for('advanced_diagnostics') }}" class="btn btn-warning me-2">Advanced Diagnostics</a>
                <a href="{{ url_for('list_collections') }}" class="btn btn-outline-secondary me-2">Collections</a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Home</a>
            </div>
        </header>

        {% if db_path %}
        <div class="alert alert-success mb-4">
            <strong>ChromaDB path:</strong> {{ db_path }}
        </div>
        {% endif %}

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'error' else 'danger' }}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Database Path Info -->
        {% if not db_path %}
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h2 class="mb-0">ChromaDB Connection</h2>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <strong>Not connected to any ChromaDB!</strong> Could not find a valid ChromaDB directory.
                        </div>

                        <h5>Paths Checked:</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Path</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for path_info in paths_info %}
                                    <tr>
                                        <td>{{ path_info.path }}</td>
                                        <td>
                                            {% if path_info.is_current %}
                                                <span class="badge bg-success">Current</span>
                                            {% elif path_info.exists %}
                                                <span class="badge bg-info">Exists</span>
                                            {% else %}
                                                <span class="badge bg-danger">Not Found</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="alert alert-info">
                            <h5>Help</h5>
                            <p>If ChromaDB path is incorrect, you can:</p>
                            <ol>
                                <li>Set the <code>CHROMADB_PATH</code> environment variable to the correct path</li>
                                <li>Modify the <code>CHROMADB_PATHS</code> list in <code>lamb_kb_webapp.py</code></li>
                                <li>Run the webapp from the right directory (where `data/chromadb` is found)</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h2 class="mb-0">ChromaDB Collections</h2>
                    </div>
                    <div class="card-body">
                        <p class="lead">This page allows you to inspect ChromaDB collections directly, bypassing the Lamb KB API. Use this to debug issues with embeddings and metadata.</p>

                        <!-- Collection Mapping Table -->
                        <h5 class="mt-3 mb-3">Collection Mapping Status</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-primary">
                                    <tr>
                                        <th>SQLite Collection</th>
                                        <th>ChromaDB Collection</th>
                                        <th>UUID</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for col in collection_mapping %}
                                    <tr class="{{ 'table-warning' if col.get('only_in_chroma', False) else '' }}">
                                        <td>
                                            {% if col.sqlite_name %}
                                                <strong>{{ col.sqlite_name }}</strong>
                                                <small class="text-muted d-block">ID: {{ col.sqlite_id }}</small>
                                            {% else %}
                                                <span class="badge bg-danger">Not in SQLite</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if col.found_in_api %}
                                                {{ col.chroma_name }}
                                                {% if col.sqlite_name and col.sqlite_name != col.chroma_name %}
                                                    <span class="badge bg-warning">Case Mismatch</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-danger">Not Found</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if col.found_uuid %}
                                                <code>{{ col.uuid }}</code>
                                            {% else %}
                                                <!-- Show potential matches -->
                                                {% set potential_matches = [] %}
                                                {% for internal_col in chromadb_internal_collections %}
                                                    {% if col.sqlite_name and internal_col.name.lower().strip() == col.sqlite_name.lower().strip() %}
                                                        {% set _ = potential_matches.append(internal_col.id) %}
                                                    {% endif %}
                                                {% endfor %}
                                                
                                                {% if potential_matches|length > 0 %}
                                                    <code>{{ potential_matches[0] }}</code>
                                                    <span class="badge bg-warning">Auto-matched</span>
                                                {% else %}
                                                    <span class="badge bg-danger">No UUID</span>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if col.get('only_in_chroma', False) %}
                                                <span class="badge bg-warning">Only in ChromaDB</span>
                                            {% elif col.found_in_api and col.found_uuid %}
                                                <span class="badge bg-success">Matched</span>
                                            {% elif col.found_in_api %}
                                                <span class="badge bg-warning">No UUID</span>
                                            {% elif col.found_uuid %}
                                                <span class="badge bg-warning">Only in Internal ChromaDB</span>
                                            {% else %}
                                                <span class="badge bg-danger">Missing in ChromaDB</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Original ChromaDB API Collections List -->
                        <h5 class="mt-4 mb-3">ChromaDB API Collections</h5>
                        {% if collections %}
                            <div class="list-group mb-4">
                                {% for collection in collections %}
                                    <a href="{{ url_for('debug_collection', collection_name=collection) }}" class="list-group-item list-group-item-action">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">{{ collection }}</h5>
                                        </div>
                                        <p class="mb-1">Inspect embeddings, metadata, and chunking strategies</p>
                                    </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <h4 class="alert-heading">No ChromaDB collections found!</h4>
                                <p>There are no collections in the ChromaDB database.</p>
                                {% if not db_path %}
                                    <p><strong>Reason:</strong> Could not connect to ChromaDB. Check the paths above.</p>
                                {% endif %}
                            </div>
                        {% endif %}

                        <!-- Internal ChromaDB Collections -->
                        <h5 class="mt-4 mb-3">ChromaDB Internal Collections</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>UUID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for collection in chromadb_internal_collections %}
                                    <tr>
                                        <td>{{ collection.name }}</td>
                                        <td><code>{{ collection.id }}</code></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <div class="card bg-light">
                    <div class="card-header">
                        <h3 class="mb-0">Common Issues & Solutions</h3>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="troubleshootingAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        No query results despite having documents
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <p>This is often caused by mixed chunking strategies in the same collection. When you use different parameters for ingesting files (e.g., word vs. character chunking), ChromaDB may filter out results unexpectedly.</p>
                                        <strong>Solutions:</strong>
                                        <ul>
                                            <li>Use the "Include all metadata" option when querying</li>
                                            <li>Check the chunking strategies in each collection</li>
                                            <li>Use consistent chunking parameters across all files in a collection</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        Embedding dimension mismatch errors
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <p>This occurs when you try to add documents with a different embedding model than was used to create the collection.</p>
                                        <strong>Solutions:</strong>
                                        <ul>
                                            <li>Check embedding dimensions in the collection details</li>
                                            <li>Make sure all files use the same embedding model</li>
                                            <li>Create a new collection if you need to change embedding models</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                        Unexpected query results or poor relevance
                                    </button>
                                </h2>
                                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <p>If your results seem unrelated to your query, there may be issues with your document chunking or embedding model.</p>
                                        <strong>Solutions:</strong>
                                        <ul>
                                            <li>Adjust chunking parameters (smaller chunks often work better)</li>
                                            <li>Try a different embedding model for better semantic understanding</li>
                                            <li>Examine document metadata to ensure proper content ingestion</li>
                                            <li>Lower the similarity threshold to see more results</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-5 text-center text-muted">
            <p>Lamb Knowledge Base Server Explorer | <a href="https://github.com/Lamb-Project/lamb-kb-server" target="_blank">GitHub</a></p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 